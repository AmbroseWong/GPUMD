.. _kw_ensemble:
.. index::
   single: ensemble (keyword in run.in)

:attr:`ensemble`
================

This keyword is used to set up an integration method (an integrator).
Background information pertaining to the representation of different ensembles in :term:`MD` simulations can be found :ref:`here <ensembles>`.


Syntax
------

The number of optional parameters depends on the first parameter, which can assume any of the following values::

    nve
    nvt_ber
    nvt_nhc
    nvt_bdp
    nvt_lan
    nvt_bao
    nph_mttk
    npt_mttk
    npt_ber
    npt_scr
    heat_nhc
    heat_bdp
    heat_lan
    pimd
    rpmd
    trpmd

:attr:`nve`
^^^^^^^^^^^
If the first parameter is :attr:`nve`, it means that the ensemble for the current run is NVE (micro-canonical).
There is no need to further specify any other parameters. Therefore, the full command is::

    ensemble nve

.. include:: ensemble_mttk.rst

:attr:`nvt_ber`
^^^^^^^^^^^^^^^
If the first parameter is :attr:`nvt_ber`, it means that the ensemble for the current run is NVT (canonical) generated by using the :ref:`Berendsen method <berendsen_thermostat>`.
In this case, one needs to specify an initial target temperature :attr:`T_1`, a final target temperature :attr:`T_2`, and a parameter :attr:`T_coup`, which reflects the strength of the coupling between the system and the thermostat. The full command is::

    ensemble nvt_ber T_1 T_2 T_coup
 
The target temperature (not the instant system temperature) will vary linearly from :attr:`T_1` to :attr:`T_2` during a run.
The choice of :attr:`T_coup` is discussed :ref:`below <choice_of_parameters>`.

:attr:`nvt_nhc`
^^^^^^^^^^^^^^^
If the first parameter is :attr:`nvt_nhc`, it is similar to the case of :attr:`nvt_ber`, but using the :ref:`Nose-Hoover chain method <nose_hoover_chain_thermostat>`.

:attr:`nvt_bdp`
^^^^^^^^^^^^^^^
If the first parameter is :attr:`nvt_bdp`, it is similar to the case of :attr:`nvt_ber`, but using the :ref:`Bussi-Donadio-Parrinello method <bdp_thermostat>`.

:attr:`nvt_lan`
^^^^^^^^^^^^^^^
If the first parameter is :attr:`nvt_lan`, it is similar to the case of :attr:`nvt_ber`, but using the :ref:`Langevin method <langevin_thermostat>` as proposed in [Bussi2007a]_.

:attr:`nvt_bao`
^^^^^^^^^^^^^^^
If the first parameter is :attr:`nvt_bao`, it is similar to the case of :attr:`nvt_ber`, but using the Langevin method with BAOAB splitting [Leimkuhler2013]_.

:attr:`npt_ber`
^^^^^^^^^^^^^^^
If the first parameter is :attr:`npt_ber`, it means that the ensemble for the current run is NPT (isothermalâ€“isobaric) generated by using the :ref:`Berendsen barostat <berendsen_barostat>`.
In this case, apart from the same parameters as in the case of :attr:`nvt_ber`, one needs to further specify some target pressure(s), the same number of estimated elastic moduli, and a pressure coupling constant :attr:`p_coup`.
The general format is::

  ensemble npt_ber <T_1> <T_2> <T_coup> {<pressure_control_parameters>}

with three different options for specifying :attr:`pressure_control_parameters`:

* *Condition 1*: Cell shape updates are isotropic

  .. code::

     <p_hydro> <C_hydro> <p_coup>
    
  This means you regard your system as isotropic and want to control the three box lengths uniformly according to the hydrostatic pressure :attr:`p_hydro = (p_xx + p_yy + p_zz)/3`.
  All directions should have periodic boundary conditions.
  Currently, we require the box to be orthogonal.

* *Condition 2*: Cell shape updates are orthorhombic

  .. code::

     <p_xx> <p_yy> <p_zz> <C_xx> <C_yy> <C_zz> <p_coup>

  In this case, the simulation box must be orthogonal.
  The three box lengths will be controlled independently according to their respective target pressures.
  Any direction can be either periodic or nonperiodic and pressure controlling will only be effective in periodic directions.

* *Condition 3*: Cell shape updates are triclinic

  .. code::

     <p_xx> <p_yy> <p_zz> <p_yz> <p_xz> <p_xy> <C_xx> <C_yy> <C_zz> <C_yz> <C_xz> <C_xy> <p_coup>

  The simulation box must be triclinic and all the directions must be periodic.
  All cell components will be controlled independently according to the 6 target pressure components.

  Elastic constants in literature may use a different nomenclature. The correspondence is as follows:

  | :attr:`C_xx=C_xxxx=C_11`, :attr:`C_yy=C_yyyy=C_22`, :attr:`C_zz=C_zzzz=C_33`,
  | :attr:`C_yz=C_yzyz=C_44`, :attr:`C_zx=C_zxzx=C_55`, :attr:`C_xy=C_xyxy=C_66`
  
  It is sufficient for the elastic constant tensor :attr:`C_ab` to be a (very rough) estimate as long as it is of the right magnitude.
  It is used to convert the coupling constant (or relaxation time, see :ref:`here <choice_of_parameters>`) of the barostat into suitable internal units.

:attr:`npt_scr`
^^^^^^^^^^^^^^^
If the first parameter is :attr:`npt_scr`, it is similar to the case of :attr:`npt_ber`, but using the :ref:`stochastic cell rescaling method <stochastic_cell_rescaling>`.

:attr:`heat_nhc`
^^^^^^^^^^^^^^^^
If the first parameter is :attr:`heat_nhc`, it means heating a source region and simultaneously cooling a sink region using local :ref:`Nose-Hoover chain thermostats <nose_hoover_chain_thermostat>`.
The full command is::

  ensemble heat_nhc <T> <T_coup> <delta_T> <label_source> <label_sink>

The target temperatures in the source region with label :attr:`label_source` and the sink region with label :attr:`label_sink` are :attr:`T+delta_T` and :attr:`T-delta_T`, respectively.
Therefore, the temperature difference between the two regions is two times :attr:`delta_T`.
In the command above, the parameter :attr:`T_coup` has the same meaning as in the case of :attr:`nvt_nhc`.
Both :attr:`label_source` and :attr:`label_sink` refer to the 0-th grouping method.

:attr:`heat_bdp`
^^^^^^^^^^^^^^^^
If the first parameter is :attr:`heat_bdp`, it is similar to the case of :attr:`heat_nhc`, but using the :ref:`Bussi-Donadio-Parrinello method <bdp_thermostat>`.

:attr:`heat_lan`
^^^^^^^^^^^^^^^^
If the first parameter is :attr:`heat_lan`, it is similar to the case of :attr:`heat_nhc`, but using the :ref:`Langevin method <langevin_thermostat>`.

:attr:`pimd`
^^^^^^^^^^^^
If the first parameter is :attr:`pimd`, it means that the current run will use path-integral molecular dynamics (:term:`PIMD`).

It can be used in the following ways::

    ensemble pimd <num_beads> <T_1> <T_2> <T_coup> 
    ensemble pimd <num_beads> <T_1> <T_2> <T_coup> {<pressure_control_parameters>}

In both cases, :attr:`num_beads` is the number of beads in the ring polymer, which should be a positive even integer no larger than 128.
The first case is similar to the NVT ensemble with :attr:`nvt_lan` as the Langevin thermostat is used for both the internal and the centroid modes [Ceriotti2010]_. 
The second case is similar to the NPT ensemble with :attr:`npt_ber`, where a Berendsen barostat is added compared to the first case.
Note that :attr:`pimd` (that is, not :attr:`rpmd` or :attr:`trpmd` described below) must be the first run that requires to set :attr:`num_beads` and one cannot change :attr:`num_beads` from run to run.

:attr:`rpmd`
^^^^^^^^^^^^
If the first parameter is :attr:`rpmd`, it means that the current run will use ring-polymer molecular dynamics (:term:`RPMD`) [Craig2004]_.

It can be used as follows::

    ensemble rpmd <num_beads> 

This can be understood as the NVE version of :term:`PIMD`, where no thermostat is applied.

:attr:`trpmd`
^^^^^^^^^^^^^
If the first parameter is :attr:`trpmd`, it means that the current run will use thermostatted ring-polymer molecular dynamics (:term:`TRPMD`) [Rossi2014]_.

It can be used as follows::

    ensemble trpmd <num_beads> 

This is similar to :term:`RPMD`, but the Langevin thermosat is applied to the internal modes.

.. _choice_of_parameters:

Units and suggested parameters
------------------------------

The units of temperature and pressure for this keyword are K and GPa, respectively. 

The temperature coupling constant :attr:`T_coup` means :math:`\tau_T/\Delta t`, where :math:`\tau_T` is the relaxation time of the thermostat and :math:`\Delta t` is the time step for integration.
We require :math:`\tau_T/\Delta t \geq 1` and a good choice is :math:`\tau_T/\Delta t \approx 100`.

When :math:`\tau_T/\Delta t > 100000`, the Berendsen thermostat in :attr:`npt_ber` will be completely ignored, leaving only the Berendsen barostat. In this case, the NPT ensemble reduces to the NPH ensemble that can be useful for melting point calculations using the two-phase method. We have not yet achieved a similar NPH ensemble using the :ref:`stochastic cell rescaling method <stochastic_cell_rescaling>`.

The pressure coupling constant :attr:`p_coup` means :math:`\tau_p/\Delta t`, where :math:`\tau_p` is the relaxation time of the barostat and :math:`\Delta t` is the time step for integration.
We require :math:`\tau_p/\Delta t \geq 1` and a good choice is :math:`\tau_p/\Delta t \approx 1000`.

The elastic constants are in units of GPa.


Caveats
-------
One should use one and only one instance of this keyword for each :ref:`run keyword <kw_run>`.
